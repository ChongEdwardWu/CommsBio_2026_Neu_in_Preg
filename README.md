# CommsBio_26_Neutrophil_in_Pregnancy

Code for the single-cell RNA-seq analysis of neutrophils in healthy pregnancy and gestational diabetes mellitus (GDM) used in the Communications Biology manuscript.

The repository contains R and Python scripts to perform quality control, clustering, gene regulatory network inference (pySCENIC), differential expression and enrichment analyses, trajectory inference, and figure generation. One additional script (`R/07_Revision.r`) records the analyses performed during the revision stage (reference mapping and updated NP vs GDM comparisons).

---

## Repository structure

- `R/01_QC_DR_Clustering.r`  
  Quality control, calculation of QC metrics (mitochondrial, ribosomal, hemoglobin, platelet, heat-shock), filtering of low-quality cells, `SCTransform` normalisation, PCA, UMAP and clustering of the neutrophil scRNA-seq data.  
  Input: `path_to_seurat_object/XJY1SMK_Seurat.rds`  
  Main outputs:  
  - `01_1_seu_filtered_after_QC.rds`  
  - `01_2_seu_after_SCTransform.rds`  
  - `01_3_seu_with_dimRed_and_clusters.rds` (used by downstream scripts)

- `R/02_pySCENIC_Preparation.r`  
  Prepares the filtered neutrophil Seurat object for pySCENIC. Extracts a filtered expression matrix and writes a `.loom` file containing counts and metadata.  
  Input: `01_3_seu_with_dimRed_and_clusters.rds`  
  Output: `02_pySCENIC_seu_filtered.loom`

- `R/03_pySCENIC_results_into_seurat.r`  
  Imports pySCENIC results (regulons, AUC scores, binarised activity) back into the Seurat object.  
  Inputs:  
  - `01_3_seu_with_dimRed_and_clusters.rds`  
  - pySCENIC outputs stored under `SCENICdir` (see script)  
  Output: `03_pySCENIC2seurat.rds`

- `R/04_DEG.r`  
  Performs differential expression analyses at multiple levels (cluster markers, GDM vs NP, subgroup comparisons), including pseudobulk-style DE and pathway enrichment (GO, KEGG, Reactome, Hallmark).  
  Input: `03_pySCENIC2seurat.rds`  
  Outputs:  
  - `04_GDMvsNP_allCellType.rds`  
  - `04_LD-S100A4_vs_LD-MMP9.rds`  
  - Multiple Excel tables under `results/` with DEG lists and enrichment results.

- `R/05_trajectory.r`  
  Trajectory and pseudotime analysis using `slingshot`, `tradeSeq`, `condiments` and `monocle3`.  
  Input: `04_GDMvsNP_allCellType.rds`  
  Outputs (examples):  
  - `05_sce_for_slingshot.rds`  
  - `05_sce_sub_for_slingshot.rds`

- `R/06_Figures.r`  
  Generates the main and supplementary figures (UMAPs, dot plots, bar plots, Nebulosa density plots, volcano plots, trajectory visualisations, etc.).  
  Inputs:  
  - `04_GDMvsNP_allCellType.rds`  
  - `04_LD-S100A4_vs_LD-MMP9.rds`  
  - `05_sce_for_slingshot.rds`  
  - `05_sce_sub_for_slingshot.rds`  
  - Pre-computed pseudobulk results  
    - `04_PseudobulK_DEG-HD_vs_LD.rds`  
    - `04_Pseudobulk_regulons-HD_vs_LD.rds`  
    (these two RDS files are generated by a separate pseudobulk pipeline and are not created by the scripts in this repository)

- `R/07_Revision.r`  
  Scripts added during revision. This script:  
  - maps the pregnancy neutrophil dataset to the published Ostuni human neutrophil reference (`Fig6_adjusted.rds`) using Seurat’s reference mapping;  
  - compares NP vs GDM within low-density (LD) and high-density (HD) neutrophil fractions;  
  - performs GO and GSEA-based pathway analysis for these comparisons;  
  - generates additional figures (e.g. reference/query UMAPs, cluster abundance bar plots, volcano plots and GSEA bar plots) and summary Excel files.  
  By default it expects:  
  - `data/reference/Fig6_adjusted.rds`  
  - `data/seurat/04_GDMvsNP_allCellType.rds`  
  and writes outputs to:  
  - `data/reference/Fig6_processed.rds`  
  - `data/seurat/07_seu_mapped.rds`  
  - `figures/fig14_*.png/.pdf` to `figures/fig21_*.png/.pdf`  
  - `results/07_Ref_mapping_cluster.xlsx`, `results/07_GDMvsNP_LD_major.xlsx`, `results/07_GDMvsNP_HD_major.xlsx`, and the corresponding `.rds` files.

- `python/run_SCENIC.py`  
  Python script to run the pySCENIC workflow (GRN inference, motif enrichment, AUC calculation, binarisation). It expects the `.loom` file produced by `R/02_pySCENIC_Preparation.r` and appropriate ranking databases and motif annotation files.

---

## Analysis workflow

1. **QC, normalisation and clustering**  
   Run `R/01_QC_DR_Clustering.r` after setting `workdir` and the path to `XJY1SMK_Seurat.rds`. This produces `01_3_seu_with_dimRed_and_clusters.rds`.

2. **Prepare input for pySCENIC**  
   Run `R/02_pySCENIC_Preparation.r` to generate `02_pySCENIC_seu_filtered.loom`.

3. **Run pySCENIC (Python)**  
   Use `python/run_SCENIC.py` to run pySCENIC on `02_pySCENIC_seu_filtered.loom`. This produces adjacency, motif and AUC files and a SCENIC `.loom` file with regulon activities.

4. **Import SCENIC results into Seurat**  
   Run `R/03_pySCENIC_results_into_seurat.r` to integrate SCENIC outputs into the Seurat object, creating `03_pySCENIC2seurat.rds`.

5. **Differential expression and enrichment analyses**  
   Run `R/04_DEG.r` starting from `03_pySCENIC2seurat.rds`. This script produces multiple DEG tables, enrichment analyses and the key intermediate objects `04_GDMvsNP_allCellType.rds` and `04_LD-S100A4_vs_LD-MMP9.rds`.

6. **Trajectory analysis**  
   Run `R/05_trajectory.r` to perform trajectory inference and pseudotime analyses, producing `05_sce_for_slingshot.rds` and `05_sce_sub_for_slingshot.rds`.

7. **Figure generation**  
   Run `R/06_Figures.r` to generate the main and supplementary figures used in the manuscript. This script expects the intermediate `.rds` files listed above and the pre-computed pseudobulk results.

8. **Revision analyses (optional)**  
   Run `R/07_Revision.r` if you wish to reproduce the additional analyses performed during revision (reference mapping to the Ostuni dataset and updated NP vs GDM comparisons within LD/HD). Adjust `dir_data` at the top of the script if your data are stored in a different location.

---

## Input data

- Raw scRNA-seq data are available from GSA-Human under accession **HRA010023** (see the manuscript for details).  
- The initial Seurat object `XJY1SMK_Seurat.rds` used by `R/01_QC_DR_Clustering.r` is generated from the raw data using an upstream pipeline (read alignment, quantification, cell calling and neutrophil selection) described in the Methods section of the paper and is not included in this repository.  
- All scripts assume that you have created this initial Seurat object and placed it at the location specified by `path_to_seurat_object/XJY1SMK_Seurat.rds` (in `R/01_QC_DR_Clustering.r`).

For the revision analyses (`R/07_Revision.r`), the following additional inputs are required:

- `Fig6_adjusted.rds`: processed reference object derived from the published Ostuni human neutrophil dataset, kindly provided by Dr. Renato Ostuni (Vita-Salute San Raffaele University). Please get in touch with Dr. Ostuni to request these data and cite the original paper “Cellular and transcriptional dynamics of human neutrophils at steady state and upon stress” (Nat Immunol. 2022; 23:1470-1483). 
- `04_GDMvsNP_allCellType.rds`: generated by `R/04_DEG.r` and expected under `data/seurat/` when running `R/07_Revision.r`.

---

## Configuration and paths

Several scripts use placeholder paths that should be adapted to your environment before running:

- `workdir <- "path_to_data"` – base working directory (typically the project folder).  
- `source("path_to_.radian_profile")` – optional; can be commented out if you do not use a custom radian profile.  
- `seu <- readRDS("path_to_seurat_object/XJY1SMK_Seurat.rds")` – location of the initial neutrophil Seurat object.  
- `SCENICdir <- "path_to_SCENIC_results"` – folder containing pySCENIC outputs used by `R/03_pySCENIC_results_into_seurat.r`.  
- In `R/07_Revision.r`, the variable `dir_data` controls where the scripts look for `reference` and `seurat` subdirectories. Adjust this to match your local layout, or create the `data/reference` and `data/seurat` folders under the repository root.

---

## Software requirements

The analysis was developed and tested with:

- **R** (recent 4.x series) with the following key packages (non-exhaustive):  
  `Seurat`, `SeuratDisk`, `SeuratWrappers`, `SingleCellExperiment`,  
  `SCENIC`, `SCopeLoomR`, `AUCell`,  
  `slingshot`, `tradeSeq`, `condiments`, `monocle3`,  
  `scater`, `scran`,  
  `clusterProfiler`, `fgsea`, `msigdbr`, `enrichplot`,  
  `org.Hs.eg.db`, `org.Mm.eg.db`,  
  `Nebulosa`, `EnhancedVolcano`, `dittoSeq`,  
  `ggplot2`, `patchwork`, `cowplot`,  
  `dplyr`, `stringr`, `tidyr`,  
  `httpgd`, `future`,  
  `rJava`, `xlsx` or `openxlsx2`.

- **Python** (≥ 3.8) with:  
  `pyscenic`, `pandas`, `loompy`, and the pySCENIC command line tools available on the `PATH`, plus appropriate ranking databases and motif annotation files for the species analysed.

Please refer to the individual scripts for the complete list of `library()` and `import` statements.

---

## Contact

For questions about the code or analyses, please open an issue on this GitHub repository or contact:

- **Chong Wu** – wuchong5@mail(dot)sysu(dot)edu(dot)cn
